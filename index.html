<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MK Delivery Pro</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #F8F9FA; padding-bottom: 0; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* MK Theme */
        .bg-mk-red { background-color: #ce1126; }
        .text-mk-red { color: #ce1126; }
        .border-mk-red { border-color: #ce1126; }
        
        /* Page Navigation System */
        .page { 
            display: none; 
            width: 100%; 
            min-height: 100vh; 
            background: #F8F9FA;
            padding-bottom: 80px; /* Space for bottom nav */
            animation: fadeIn 0.2s ease-out;
        }
        .page.active { display: block; }
        .page.full-screen { padding-bottom: 0; z-index: 50; position: fixed; top: 0; left: 0; overflow-y: auto; height: 100%; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Scroll & Utilities */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .category-btn.active { background-color: #ce1126; color: white; border-color: #ce1126; }
        
        /* Bottom Nav */
        .nav-item.active-tab { color: #ce1126; }
        .nav-item.inactive-tab { color: #9CA3AF; }

        /* Map */
        #map { height: 100%; width: 100%; }
        .center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 1000; pointer-events: none; }
    </style>
</head>
<body>

    <section id="page-home" class="page active">
        <div class="bg-white sticky top-0 z-10 shadow-sm pb-2">
            <div class="p-4 flex justify-between items-center bg-mk-red text-white">
                <div><h1 class="text-lg font-bold">MK Delivery</h1></div>
                <div id="user-profile-icon"></div>
            </div>
            <div class="px-4 mt-[-15px]">
                <div class="bg-white rounded-lg shadow-md p-2 flex items-center border">
                    <i class="fas fa-search text-gray-400 ml-2"></i>
                    <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." class="w-full ml-3 outline-none text-sm" onkeyup="searchProduct(this.value)">
                </div>
            </div>
            <div id="category-container" class="flex overflow-x-auto space-x-2 p-3 hide-scroll mt-1"></div>
        </div>

        <div class="container mx-auto p-4">
            <div id="product-list" class="grid grid-cols-2 gap-4 pb-16">
                </div>
        </div>
    </section>

    <section id="page-history" class="page">
        <div class="bg-white p-4 shadow-sm sticky top-0 z-10">
            <h1 class="text-xl font-bold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
        </div>
        <div id="history-list" class="p-4 space-y-3 pb-20"></div>
    </section>

    <section id="page-profile" class="page">
        <div class="bg-mk-red p-6 text-white text-center rounded-b-3xl shadow-md">
            <div id="profile-img-large" class="w-20 h-20 bg-white rounded-full mx-auto border-4 border-white shadow-lg overflow-hidden"></div>
            <h2 id="profile-name" class="text-xl font-bold mt-3">Guest</h2>
        </div>
        <div class="p-4 -mt-4">
            <div class="bg-white rounded-xl shadow-lg p-5 space-y-4">
                <h3 class="font-bold text-gray-700 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <input type="text" id="prof-name" class="w-full border-b p-2 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                <input type="tel" id="prof-tel" class="w-full border-b p-2 outline-none" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" maxlength="10">
                <textarea id="prof-address" rows="2" class="w-full border rounded p-2 outline-none bg-gray-50" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"></textarea>
                <button onclick="saveProfile()" class="w-full bg-mk-red text-white font-bold py-2 rounded-lg shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </section>

    <section id="page-ai" class="page">
    <div class="bg-mk-red p-6 text-white text-center rounded-b-3xl shadow-md pb-10">
        <i class="fas fa-magic text-4xl mb-2 text-yellow-300"></i>
        <h2 class="text-2xl font-bold">‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏´‡∏°?</h2>
        <p class="text-sm opacity-90">‡∏ö‡∏≠‡∏Å‡∏á‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ!</p>
    </div>

    <div class="p-4 -mt-8">
        <div class="bg-white rounded-xl shadow-lg p-5 space-y-4">
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button onclick="setAiMode('budget')" id="btn-mode-budget" class="flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-mk-red transition">üí∞ ‡∏ï‡∏≤‡∏°‡∏á‡∏ö</button>
                <button onclick="setAiMode('kcal')" id="btn-mode-kcal" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 transition">üî• ‡∏ï‡∏≤‡∏°‡πÅ‡∏Ñ‡∏•‡∏Ø</button>
            </div>

            <div id="ai-input-container" class="text-center py-4">
                <p class="text-gray-500 text-sm mb-2" id="ai-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</p>
                <div class="flex items-center justify-center space-x-2">
                    <button onclick="adjustAiValue(-10)" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600"><i class="fas fa-minus"></i></button>
                    <input type="number" id="ai-value" value="200" class="text-3xl font-bold text-center w-32 outline-none text-gray-800" readonly>
                    <button onclick="adjustAiValue(10)" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600"><i class="fas fa-plus"></i></button>
                </div>
                <input type="range" id="ai-slider" min="50" max="1000" step="10" value="200" class="w-full mt-4 accent-red-600" oninput="syncAiValue(this.value)">
            </div>

            <button onclick="generateAiSet()" class="w-full bg-mk-red text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-800 transition">
                <i class="fas fa-wand-magic-sparkles mr-2"></i>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ã‡∏ï
            </button>
        </div>

        <div id="ai-result" class="mt-6 hidden animate-slide-up">
            <h3 class="font-bold text-gray-700 mb-3 flex justify-between items-center">
                <span>‚ú® ‡πÄ‡∏ã‡∏ï‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</span>
                <button onclick="generateAiSet()" class="text-xs text-mk-red bg-red-50 px-2 py-1 rounded"><i class="fas fa-sync-alt mr-1"></i>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∏‡∏î</button>
            </h3>

            <div class="bg-white rounded-xl shadow border border-red-100 overflow-hidden relative">
                <div class="absolute top-0 left-0 bg-yellow-400 text-red-900 text-xs font-bold px-3 py-1 rounded-br-lg z-10">‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤!</div>
                
                <div id="ai-items-list" class="divide-y"></div>

                <div class="bg-red-50 p-4 flex justify-between items-center">
                    <div>
                        <p class="text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</p>
                        <p class="text-xl font-bold text-mk-red" id="ai-total-price">0 ‡∏ø</p>
                    </div>
                    <div class="text-right mr-4">
                        <p class="text-xs text-gray-500">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</p>
                        <p class="text-sm font-bold text-orange-600" id="ai-total-kcal">0 Kcal</p>
                    </div>
                    <button onclick="addAiSetToCart()" class="bg-mk-red text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-red-800">
                        ‡πÄ‡∏´‡∏°‡∏≤‡πÄ‡∏ã‡∏ï‡∏ô‡∏µ‡πâ
                    </button>
                </div>
            </div>

            <div id="ai-similar" class="mt-6 hidden">
                <h3 class="font-bold text-gray-700 mb-3 text-sm">üí° ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô</h3>
                <div id="ai-similar-list" class="space-y-2"></div>
            </div>
        </div>
    </div>
</section>

    <section id="page-product-detail" class="page full-screen bg-white hidden">
        <div class="relative">
            <button onclick="goBack()" class="absolute top-4 left-4 bg-white/80 p-2 rounded-full shadow z-10 text-gray-700">
                <i class="fas fa-arrow-left fa-lg"></i>
            </button>
            <img id="detail-img" class="w-full h-72 object-cover">
        </div>
        <div class="p-5 pb-24"> <div class="flex justify-between items-start">
                <h1 id="detail-name" class="text-2xl font-bold text-gray-800 w-3/4">Product Name</h1>
                <span id="detail-kcal" class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">0 Kcal</span>
            </div>
            <p id="detail-cat" class="text-gray-500 text-sm mb-4">Category</p>
            <p id="detail-price" class="text-3xl font-bold text-mk-red mb-6">0 ‡∏ø</p>

            <div class="mb-6">
                <label class="font-bold text-gray-700 block mb-2"><i class="far fa-comment-dots mr-2"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                <textarea id="detail-note" class="w-full bg-gray-50 border rounded-lg p-3 outline-none focus:ring-1 focus:ring-red-500" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å, ‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢"></textarea>
            </div>

            <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 shadow-lg flex items-center justify-between">
                <div class="flex items-center space-x-4 border rounded-lg px-3 py-2">
                    <button onclick="adjustDetailQty(-1)" class="text-mk-red text-xl w-8"><i class="fas fa-minus"></i></button>
                    <span id="detail-qty" class="font-bold text-xl w-6 text-center">1</span>
                    <button onclick="adjustDetailQty(1)" class="text-mk-red text-xl w-8"><i class="fas fa-plus"></i></button>
                </div>
                <button onclick="submitProductToCart()" class="bg-mk-red text-white font-bold py-3 px-8 rounded-xl shadow-lg flex-grow ml-4">
                    ‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                </button>
            </div>
        </div>
    </section>

    <section id="page-history-detail" class="page full-screen bg-white hidden">
        <div class="bg-mk-red p-4 text-white flex items-center sticky top-0 z-10 shadow-md">
            <button onclick="goBack()" class="mr-4"><i class="fas fa-arrow-left fa-lg"></i></button>
            <h1 class="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
        </div>
        <div class="p-5">
            <div class="flex justify-between items-center mb-4">
                <span id="hist-detail-id" class="text-gray-500 font-mono">#ID</span>
                <span id="hist-detail-date" class="text-sm text-gray-500">Date</span>
            </div>
            <div id="hist-detail-status-box" class="text-center p-2 rounded-lg bg-gray-100 font-bold mb-6">Status</div>
            
            <h3 class="font-bold text-gray-800 mb-2 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <div id="hist-detail-items" class="space-y-3 mb-6"></div>

            <div class="flex justify-between items-center text-xl font-bold border-t pt-4">
                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                <span id="hist-detail-total" class="text-mk-red">0 ‡∏ø</span>
            </div>
        </div>
    </section>

    <div id="cart-bar" class="fixed bottom-[70px] left-4 right-4 z-30 hidden transform transition-transform duration-300 translate-y-32">
        <div onclick="openCheckoutModal()" class="bg-mk-red text-white rounded-xl p-3 flex justify-between items-center shadow-2xl cursor-pointer hover:bg-red-800 transition">
            <div class="flex items-center space-x-3">
                <div class="bg-white text-mk-red font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm" id="cart-count">0</div>
                <span class="font-medium">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
            </div>
            <span class="font-bold text-lg" id="cart-total">0 ‡∏ø</span>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-end justify-center">
        <div class="bg-white w-full h-[95vh] rounded-t-3xl p-6 overflow-y-auto pb-20 animate-slide-up relative">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                <button onclick="closeCheckoutModal()" class="text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="cart-items-container" class="space-y-4 mb-6"></div>
            <div class="border-t border-dashed my-4"></div>
            <form id="orderForm" class="space-y-4">
                <h3 class="font-bold text-gray-700">üìç ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà</h3>
                <input type="text" id="checkout-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full border p-3 rounded-lg" required>
                <input type="tel" id="checkout-tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="w-full border p-3 rounded-lg" maxlength="10" required>
                <div class="relative">
                    <textarea id="checkout-address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="w-full border p-3 rounded-lg pr-10" required></textarea>
                    <button type="button" onclick="openMapModal()" class="absolute top-2 right-2 text-mk-red"><i class="fas fa-map-marker-alt fa-lg"></i></button>
                </div>
                <h3 class="font-bold text-gray-700 mt-4">üì∏ ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <input type="file" id="slip" accept="image/*" class="w-full" required>
                <button type="submit" id="submitBtn" class="w-full bg-mk-red text-white font-bold py-3 rounded-xl shadow-lg mt-6 flex justify-between px-6">
                    <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span><span id="final-total">0 ‡∏ø</span>
                </button>
            </form>
        </div>
    </div>

    <div id="map-modal" class="fixed inset-0 bg-white z-[70] hidden flex flex-col">
        <div class="p-4 shadow flex justify-between"><h3 class="font-bold">‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</h3><button onclick="closeMapModal()">‡∏õ‡∏¥‡∏î</button></div>
        <div class="relative flex-grow"><div id="map"></div><div class="center-pin"><i class="fas fa-map-marker-alt text-4xl text-mk-red"></i></div><button onclick="panToCurrentLocation()" class="absolute bottom-6 right-4 bg-white p-3 rounded-full shadow z-[500]"><i class="fas fa-crosshairs"></i></button></div>
        <div class="p-4"><button onclick="confirmLocation()" class="w-full bg-mk-red text-white font-bold py-3 rounded-xl">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ</button></div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-2 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] text-gray-500">
    <button onclick="switchPage('home')" class="nav-item active-tab flex flex-col items-center w-full" id="tab-home">
        <i class="fas fa-utensils text-xl mb-1"></i><span class="text-[10px]">‡πÄ‡∏°‡∏ô‡∏π</span>
    </button>
    
    <button onclick="switchPage('ai')" class="nav-item inactive-tab flex flex-col items-center w-full" id="tab-ai">
        <div class="bg-mk-red text-white w-10 h-10 rounded-full flex items-center justify-center -mt-4 border-4 border-white shadow-lg">
            <i class="fas fa-robot text-lg"></i>
        </div>
        <span class="text-[10px] mt-1 text-mk-red font-bold">AI ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ</span>
    </button>

    <button onclick="switchPage('history')" class="nav-item inactive-tab flex flex-col items-center w-full" id="tab-history">
        <i class="fas fa-history text-xl mb-1"></i><span class="text-[10px]">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
    </button>
    <button onclick="switchPage('profile')" class="nav-item inactive-tab flex flex-col items-center w-full" id="tab-profile">
        <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px]">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
    </button>
</nav>

    <script>
        const LIFF_ID = "2006820737-B6zOM56Y";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyL-HaoVYFxy3RRDLNXaandxLmC1dE-cCBQy6MUrRGuGMhkLP9wX82yM_025HC2WuHSbw/exec";
        // 
        
        let allProducts = [];
        let cart = {}; // Object: { productId: { ...itemData, note: "", quantity: 1 } }
        let userLineUid = "";
        let map, marker;
        let userProfileData = { name: '', tel: '', address: '' };
        let historyStack = []; // For back button logic

        // --- AI LOGIC ---
        let aiMode = 'budget'; // 'budget' or 'kcal'
        let currentAiSet = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà AI ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ

        // --- INIT ---
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) liff.login();
                else {
                    const profile = await liff.getProfile();
                    userLineUid = profile.userId;
                    setupProfileUI(profile);
                    fetchProducts();
                    loadProfileLocal();
                }
            } catch (err) { console.error(err); }
        }

        function setupProfileUI(profile) {
            const imgTag = `<img src="${profile.pictureUrl}" class="w-full h-full object-cover">`;
            document.getElementById('user-profile-icon').innerHTML = `<img src="${profile.pictureUrl}" class="w-8 h-8 rounded-full border border-white">`;
            document.getElementById('profile-img-large').innerHTML = imgTag;
            document.getElementById('profile-name').innerText = profile.displayName;
        }

        // --- NAVIGATION SYSTEM ---
        function switchPage(pageId) {
            historyStack = []; // Reset sub-page history when main tab changes
            document.querySelectorAll('.page').forEach(el => {
                if(!el.classList.contains('full-screen')) el.classList.remove('active');
            });
            document.querySelectorAll('.full-screen').forEach(el => el.classList.add('hidden'));

            // Tab Styles
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active-tab'); el.classList.add('inactive-tab');
            });
            document.getElementById(`tab-${pageId}`).classList.add('active-tab');
            document.getElementById(`tab-${pageId}`).classList.remove('inactive-tab');
            
            document.getElementById(`page-${pageId}`).classList.add('active');

            if(pageId === 'home') updateCartUI();
            else document.getElementById('cart-bar').classList.add('translate-y-32');

            if(pageId === 'history') fetchHistory();
        }

        function goBack() {
            // Hide all full-screen pages
            document.querySelectorAll('.full-screen').forEach(el => el.classList.add('hidden'));
            // Re-check Cart UI if returning to home
            if(document.getElementById('page-home').classList.contains('active')) updateCartUI();
        }

        // --- PRODUCT SYSTEM ---
        function fetchProducts() {
            const cached = localStorage.getItem('mk_products_cache');
            if (cached) {
                allProducts = JSON.parse(cached);
                setupCategories(allProducts);
                renderProducts(allProducts);
            }
            fetch(GAS_URL).then(res => res.json()).then(data => {
                if (JSON.stringify(data) !== cached) {
                    allProducts = data;
                    localStorage.setItem('mk_products_cache', JSON.stringify(data));
                    setupCategories(data);
                    renderProducts(data);
                }
            });
        }

        function renderProducts(products) {
            const container = document.getElementById('product-list');
            container.innerHTML = "";
            products.forEach(p => {
                const kcalTag = p.kcal ? `<span class="bg-orange-100 text-orange-600 text-[10px] px-1 rounded font-bold">${p.kcal} Kcal</span>` : '';
                const html = `
                    <div onclick="openProductDetail('${p.id}')" class="bg-white rounded-xl shadow-sm overflow-hidden flex flex-col border border-transparent hover:border-red-100 transition cursor-pointer">
                        <div class="h-32 w-full relative bg-gray-100"><img src="${p.image}" class="w-full h-full object-cover" loading="lazy"></div>
                        <div class="p-3 flex flex-col flex-grow">
                            <h3 class="font-bold text-gray-800 text-sm line-clamp-1">${p.name}</h3>
                            <div class="flex justify-between items-center mb-1"><p class="text-xs text-gray-500">${p.category||''}</p>${kcalTag}</div>
                            <div class="mt-auto flex justify-between items-center">
                                <span class="font-bold text-mk-red">${p.price}.-</span>
                                <button class="bg-red-50 text-mk-red w-7 h-7 rounded-full flex items-center justify-center border border-red-100"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML += html;
            });
        }

        // --- PRODUCT DETAIL PAGE ---
        let currentDetailId = null;
        function openProductDetail(id) {
            const p = allProducts.find(x => x.id == id);
            currentDetailId = id;
            
            document.getElementById('detail-img').src = p.image;
            document.getElementById('detail-name').innerText = p.name;
            document.getElementById('detail-price').innerText = p.price + ' ‡∏ø';
            document.getElementById('detail-cat').innerText = p.category || '';
            document.getElementById('detail-kcal').innerText = p.kcal ? p.kcal + ' Kcal' : '';
            document.getElementById('detail-kcal').style.display = p.kcal ? 'block' : 'none';
            
            // Reset fields
            document.getElementById('detail-qty').innerText = "1";
            document.getElementById('detail-note').value = "";
            
            // Show Page
            document.getElementById('page-product-detail').classList.remove('hidden');
            document.getElementById('cart-bar').classList.add('translate-y-32'); // Hide cart bar
        }

        function adjustDetailQty(delta) {
            let qty = parseInt(document.getElementById('detail-qty').innerText);
            qty += delta;
            if (qty < 1) qty = 1;
            document.getElementById('detail-qty').innerText = qty;
        }

        function submitProductToCart() {
            const qty = parseInt(document.getElementById('detail-qty').innerText);
            const note = document.getElementById('detail-note').value.trim();
            const p = allProducts.find(x => x.id == currentDetailId);

            // Add to Cart
            if (cart[currentDetailId]) {
                cart[currentDetailId].quantity += qty;
                if(note) cart[currentDetailId].note = note; // Overwrite note if new one provided
            } else {
                cart[currentDetailId] = { ...p, quantity: qty, note: note };
            }

            // Close Page & Update UI
            goBack();
            updateCartUI();
        }

        // --- CART SYSTEM ---
        function updateCartUI() {
            const items = Object.values(cart);
            const totalQty = items.reduce((sum, i) => sum + i.quantity, 0);
            const totalPrice = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            
            document.getElementById('cart-count').innerText = totalQty;
            document.getElementById('cart-total').innerText = totalPrice.toLocaleString() + ' ‡∏ø';
            document.getElementById('final-total').innerText = totalPrice.toLocaleString() + ' ‡∏ø';

            const bar = document.getElementById('cart-bar');
            if (totalQty > 0 && document.getElementById('page-home').classList.contains('active')) {
                bar.classList.remove('translate-y-32');
            } else {
                bar.classList.add('translate-y-32');
            }
            renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = "";
            Object.values(cart).forEach(item => {
                const noteHtml = item.note ? `<p class="text-xs text-mk-red"><i class="far fa-edit"></i> ${item.note}</p>` : '';
                container.innerHTML += `
                    <div class="flex justify-between border-b pb-3 mb-3 last:border-0 last:mb-0 last:pb-0">
                        <div class="flex space-x-3">
                            <img src="${item.image}" class="w-12 h-12 rounded object-cover bg-gray-100">
                            <div>
                                <p class="font-bold text-sm text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.price} x ${item.quantity}</p>
                                ${noteHtml}
                            </div>
                        </div>
                        <div class="font-bold text-sm self-center">${(item.price * item.quantity).toLocaleString()}</div>
                        <button onclick="removeFromCart('${item.id}')" class="text-gray-400 self-center ml-2"><i class="fas fa-trash"></i></button>
                    </div>`;
            });
        }

        function removeFromCart(id) { delete cart[id]; updateCartUI(); if(Object.keys(cart).length===0) closeCheckoutModal(); }

        // --- HISTORY DETAIL ---
        function fetchHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<p class="text-center text-gray-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            fetch(`${GAS_URL}?action=get_history&uid=${userLineUid}`)
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = "";
                    if(data.length===0) { list.innerHTML = `<div class="text-center mt-10 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`; return; }
                    data.forEach(order => {
                        let items = []; try { items = JSON.parse(order.items); } catch(e){ items=[{name:order.items,quantity:1,price:0}]; }
                        const total = items.reduce((sum,i)=>sum+(i.price*i.quantity),0);
                        const safeData = encodeURIComponent(JSON.stringify({...order, items, total}));
                        
                        let stColor = "bg-gray-100 text-gray-600";
                        if(order.status.includes('‡∏£‡∏≠')) stColor="bg-yellow-100 text-yellow-700";
                        if(order.status.includes('‡∏™‡πà‡∏á')||order.status.includes('‡πÄ‡∏™‡∏£‡πá‡∏à')) stColor="bg-green-100 text-green-600";
                        if(order.status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')) stColor="bg-red-100 text-red-600";

                        list.innerHTML += `
                            <div onclick="openHistoryDetail('${safeData}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer mb-3">
                                <div class="flex justify-between mb-2">
                                    <div><p class="text-xs text-gray-400">#${order.orderId.substring(0,8)}</p><p class="text-sm font-bold">${order.date}</p></div>
                                    <span class="px-2 py-1 rounded text-xs font-bold h-fit ${stColor}">${order.status}</span>
                                </div>
                                <p class="text-xs text-gray-500">${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - <b>${total.toLocaleString()} ‡∏ø</b></p>
                            </div>`;
                    });
                });
        }

        function openHistoryDetail(encoded) {
            const data = JSON.parse(decodeURIComponent(encoded));
            document.getElementById('hist-detail-id').innerText = '#' + data.orderId.substring(0,8).toUpperCase();
            document.getElementById('hist-detail-date').innerText = data.date;
            document.getElementById('hist-detail-status-box').innerText = data.status;
            document.getElementById('hist-detail-total').innerText = data.total.toLocaleString() + ' ‡∏ø';
            
            const cont = document.getElementById('hist-detail-items');
            cont.innerHTML = "";
            data.items.forEach(i => {
                cont.innerHTML += `
                    <div class="flex justify-between text-sm border-b pb-2 last:border-0">
                        <span class="text-gray-700 w-2/3">${i.name} <span class="text-xs text-gray-400">x${i.quantity}</span></span>
                        <span class="font-medium">${(i.price*i.quantity).toLocaleString()}</span>
                    </div>`;
            });
            document.getElementById('page-history-detail').classList.remove('hidden');
        }

        // --- SUBMIT ---
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...'; btn.disabled = true;
            
            const fileInput = document.getElementById('slip');
            let base64 = "";
            if (fileInput.files.length) {
                base64 = await new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(fileInput.files[0]); });
            }

            const items = Object.values(cart);
            const total = items.reduce((s,i)=>s+(i.price*i.quantity),0);
            
            const payload = {
                lineUid: userLineUid,
                name: document.getElementById('checkout-name').value,
                telephone: document.getElementById('checkout-tel').value,
                address: document.getElementById('checkout-address').value,
                image: base64,
                orderDetails: items,
                totalPrice: total
            };

            fetch(GAS_URL, { method: 'POST', mode: 'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload)})
            .then(() => { alert("‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); liff.closeWindow(); })
            .catch(() => { alert("Error"); btn.disabled=false; btn.innerHTML="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"; });
        });

        // --- HELPERS (Same as before: Profile Load/Save, Search, Categories, Modals) ---
        function loadProfileLocal() {
            const d = localStorage.getItem('mk_profile');
            if(d) {
                const p = JSON.parse(d);
                document.getElementById('prof-name').value = p.name;
                document.getElementById('prof-tel').value = p.tel;
                document.getElementById('prof-address').value = p.address;
                userProfileData = p;
            }
        }
        function saveProfile() {
            const p = {
                name: document.getElementById('prof-name').value,
                tel: document.getElementById('prof-tel').value,
                address: document.getElementById('prof-address').value
            };
            localStorage.setItem('mk_profile', JSON.stringify(p));
            userProfileData = p;
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        }
        function searchProduct(k) {
            if(!k) renderProducts(allProducts);
            else renderProducts(allProducts.filter(p=>p.name.toLowerCase().includes(k.toLowerCase())));
        }
        function setupCategories(products) {
            const categories = [...new Set(products.map(p => p.category))];
            const container = document.getElementById('category-container');
            container.innerHTML = '<button onclick="filterCategory(\'all\', this)" class="category-btn active whitespace-nowrap px-4 py-1 rounded-full border border-gray-300 text-sm text-gray-600 transition mx-1">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>';
            categories.forEach(cat => {
                if(!cat) return;
                const btn = document.createElement('button');
                btn.className = 'category-btn whitespace-nowrap px-4 py-1 rounded-full border border-gray-300 text-sm text-gray-600 transition mx-1';
                btn.innerText = cat;
                btn.onclick = () => filterCategory(cat, btn);
                container.appendChild(btn);
            });
        }
        function filterCategory(cat, btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active', 'border-mk-red', 'text-white'));
            btn.classList.add('active');
            if(cat==='all') renderProducts(allProducts);
            else renderProducts(allProducts.filter(p=>p.category===cat));
        }
        function openCheckoutModal() { 
            document.getElementById('checkout-modal').classList.remove('hidden'); 
            if(userProfileData.name) document.getElementById('checkout-name').value = userProfileData.name;
            if(userProfileData.tel) document.getElementById('checkout-tel').value = userProfileData.tel;
            if(userProfileData.address) document.getElementById('checkout-address').value = userProfileData.address;
        }
        function closeCheckoutModal() { document.getElementById('checkout-modal').classList.add('hidden'); }
        
        // Map Logic (Minimal for brevity, same as previous)
        function openMapModal() { document.getElementById('map-modal').classList.remove('hidden'); if(!map){map=L.map('map').setView([13.7563,100.5018],15);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);panToCurrentLocation();}else setTimeout(()=>map.invalidateSize(),100); }
        function closeMapModal() { document.getElementById('map-modal').classList.add('hidden'); }
        function panToCurrentLocation() { navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude,p.coords.longitude],17)); }
        function confirmLocation() { const c=map.getCenter(); document.getElementById('checkout-address').value += ` (‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${c.lat.toFixed(5)},${c.lng.toFixed(5)})`; closeMapModal(); }


            function setAiMode(mode) {
                aiMode = mode;
                const btnBudget = document.getElementById('btn-mode-budget');
                const btnKcal = document.getElementById('btn-mode-kcal');
                const label = document.getElementById('ai-label');
                const slider = document.getElementById('ai-slider');
                const input = document.getElementById('ai-value');
            
                if (mode === 'budget') {
                    btnBudget.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-mk-red transition";
                    btnKcal.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 transition";
                    label.innerText = "‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)";
                    slider.min = 50; slider.max = 1000; slider.value = 200;
                    input.value = 200;
                } else {
                    btnKcal.className = "flex-1 py-2 rounded-md text-sm font-bold bg-white shadow text-mk-red transition";
                    btnBudget.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 transition";
                    label.innerText = "‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô (Kcal)";
                    slider.min = 200; slider.max = 1500; slider.value = 500;
                    input.value = 500;
                }
            }
            
            function adjustAiValue(delta) {
                const input = document.getElementById('ai-value');
                const slider = document.getElementById('ai-slider');
                let val = parseInt(input.value) + delta;
                input.value = val;
                slider.value = val;
            }
            
            function syncAiValue(val) {
                document.getElementById('ai-value').value = val;
            }
            
            // ** ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡πÄ‡∏ã‡∏ï **
            function generateAiSet() {
                const limit = parseInt(document.getElementById('ai-value').value);
                const resultSec = document.getElementById('ai-result');
                const listContainer = document.getElementById('ai-items-list');
                
                // ‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                // (‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Category ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
                const mains = allProducts.filter(p => !p.category.includes('‡∏ô‡πâ‡∏≥') && !p.category.includes('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°') && !p.category.includes('‡∏´‡∏ß‡∏≤‡∏ô'));
                const drinks = allProducts.filter(p => p.category.includes('‡∏ô‡πâ‡∏≥') || p.category.includes('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'));
                const desserts = allProducts.filter(p => p.category.includes('‡∏´‡∏ß‡∏≤‡∏ô') || p.category.includes('‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô') || p.category.includes('‡∏ï‡∏¥‡πà‡∏°‡∏ã‡∏≥'));
            
                let bestSet = [];
                let attempts = 0;
                let found = false;
            
                // ‡∏•‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏° 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                while (attempts < 50 && !found) {
                    let set = [];
                    let currentTotal = 0;
                    let currentKcal = 0;
            
                    // 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏°‡∏µ)
                    const randomMain = mains[Math.floor(Math.random() * mains.length)];
                    if(randomMain) {
                        set.push(randomMain);
                        currentTotal += randomMain.price;
                        currentKcal += (randomMain.kcal || 0);
                    }
            
                    // 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡∏™‡∏∏‡πà‡∏° 70% ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏µ)
                    if (drinks.length > 0 && Math.random() > 0.3) {
                        const randomDrink = drinks[Math.floor(Math.random() * drinks.length)];
                        set.push(randomDrink);
                        currentTotal += randomDrink.price;
                        currentKcal += (randomDrink.kcal || 0);
                    }
            
                    // 3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô (‡∏™‡∏∏‡πà‡∏° 50% ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏µ)
                    if (desserts.length > 0 && Math.random() > 0.5) {
                        const randomDessert = desserts[Math.floor(Math.random() * desserts.length)];
                        set.push(randomDessert);
                        currentTotal += randomDessert.price;
                        currentKcal += (randomDessert.kcal || 0);
                    }
            
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
                    if (aiMode === 'budget') {
                        // ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö ‡πÅ‡∏•‡∏∞ ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏á‡∏ö 80%)
                        if (currentTotal <= limit && currentTotal > (limit * 0.5)) {
                            bestSet = set;
                            found = true;
                        }
                    } else {
                        // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô
                        if (currentKcal <= limit && currentKcal > (limit * 0.6)) {
                            bestSet = set;
                            found = true;
                        }
                    }
                    attempts++;
                }
            
                if (bestSet.length === 0) {
                    alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ã‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
                    return;
                }
            
                currentAiSet = bestSet; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡∏î‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                listContainer.innerHTML = "";
                let totalPrice = 0;
                let totalKcal = 0;
            
                bestSet.forEach(p => {
                    totalPrice += p.price;
                    totalKcal += (p.kcal || 0);
                    listContainer.innerHTML += `
                        <div class="flex items-center p-3">
                            <img src="${p.image}" class="w-12 h-12 rounded-lg object-cover bg-gray-100">
                            <div class="ml-3 flex-grow">
                                <p class="font-bold text-sm text-gray-800">${p.name}</p>
                                <p class="text-xs text-gray-500">${p.category} | ${p.kcal || '-'} Kcal</p>
                            </div>
                            <p class="font-bold text-mk-red">${p.price} ‡∏ø</p>
                        </div>
                    `;
                });
            
                document.getElementById('ai-total-price').innerText = totalPrice + " ‡∏ø";
                document.getElementById('ai-total-kcal').innerText = totalKcal + " Kcal";
                resultSec.classList.remove('hidden');
            
                // Generate Similar Items (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                generateSimilarItems(bestSet[0]); // ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Similar (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô)
            function generateSimilarItems(mainDish) {
                const container = document.getElementById('ai-similar');
                const list = document.getElementById('ai-similar-list');
                
                // ‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°
                const similars = allProducts
                    .filter(p => p.category === mainDish.category && p.id !== mainDish.id)
                    .sort(() => 0.5 - Math.random()) // Shuffle
                    .slice(0, 2); // ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤ 2 ‡∏≠‡∏±‡∏ô
            
                if (similars.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
            
                list.innerHTML = "";
                similars.forEach(p => {
                    list.innerHTML += `
                        <div onclick="replaceMainDish('${p.id}')" class="bg-white p-2 rounded border flex justify-between items-center cursor-pointer hover:bg-gray-50">
                            <div class="flex items-center">
                                 <img src="${p.image}" class="w-8 h-8 rounded object-cover">
                                 <span class="text-xs font-bold ml-2 text-gray-700">${p.name}</span>
                            </div>
                            <span class="text-xs text-mk-red font-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô <i class="fas fa-exchange-alt"></i></span>
                        </div>
                    `;
                });
                container.classList.remove('hidden');
            }
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô" ‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡πÄ‡∏ã‡∏ï
            function replaceMainDish(newId) {
                const newMain = allProducts.find(p => p.id == newId);
                // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÉ‡∏ô currentAiSet (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠ Main ‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏≤‡∏° Logic)
                currentAiSet[0] = newMain;
                
                // Re-render
                const listContainer = document.getElementById('ai-items-list');
                listContainer.innerHTML = "";
                let totalPrice = 0;
                let totalKcal = 0;
            
                currentAiSet.forEach(p => {
                    totalPrice += p.price;
                    totalKcal += (p.kcal || 0);
                    listContainer.innerHTML += `
                        <div class="flex items-center p-3">
                            <img src="${p.image}" class="w-12 h-12 rounded-lg object-cover bg-gray-100">
                            <div class="ml-3 flex-grow">
                                <p class="font-bold text-sm text-gray-800">${p.name}</p>
                                <p class="text-xs text-gray-500">${p.category} | ${p.kcal || '-'} Kcal</p>
                            </div>
                            <p class="font-bold text-mk-red">${p.price} ‡∏ø</p>
                        </div>
                    `;
                });
                document.getElementById('ai-total-price').innerText = totalPrice + " ‡∏ø";
                document.getElementById('ai-total-kcal').innerText = totalKcal + " Kcal";
            }
            
            function addAiSetToCart() {
                currentAiSet.forEach(p => {
                    // Reuse existing addToCart logic but silent
                    if (cart[p.id]) cart[p.id].quantity++;
                    else cart[p.id] = { ...p, quantity: 1 };
                });
                
                updateCartUI();
                
                // Animation/Feedback
                alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${currentAiSet.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!`);
                
                // Switch back to Home to see cart
                switchPage('home');
            }

        main();
    </script>
</body>
</html>
