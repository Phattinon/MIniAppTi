<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MK Delivery Clone</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #F8F9FA; padding-bottom: 90px; }
        
        /* MK Theme Colors */
        .bg-mk-red { background-color: #ce1126; }
        .text-mk-red { color: #ce1126; }
        .border-mk-red { border-color: #ce1126; }
        .hover-bg-mk-dark:hover { background-color: #a00503; }
        
        /* Category Scroll Bar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .category-btn.active { background-color: #ce1126; color: white; border-color: #ce1126; }
        
        .modal-open { overflow: hidden; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="bg-white shadow-sm sticky top-0 z-10">
        <div class="p-4 flex justify-between items-center border-b">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-mk-red rounded text-white flex items-center justify-center font-bold">MK</div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">MK Delivery</h1>
                    <p class="text-xs text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡∏ï‡∏£‡∏á‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>
                </div>
            </div>
            <div id="user-profile" class="hidden"></div>
        </div>

        <div id="category-container" class="flex overflow-x-auto space-x-2 p-3 bg-white hide-scroll border-b">
            <button onclick="filterCategory('all')" class="category-btn active whitespace-nowrap px-4 py-1 rounded-full border border-gray-300 text-sm text-gray-600 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div id="product-list" class="grid grid-cols-2 gap-4 pb-4">
            <div class="bg-white rounded-xl p-3 shadow-sm h-48 animate-pulse"></div>
            <div class="bg-white rounded-xl p-3 shadow-sm h-48 animate-pulse"></div>
        </div>
    </div>

    <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 z-20 hidden transform transition-transform duration-300 translate-y-full">
        <div onclick="openCheckoutModal()" class="bg-mk-red text-white rounded-lg p-3 flex justify-between items-center shadow-lg cursor-pointer active:scale-95 transition-transform hover-bg-mk-dark">
            <div class="flex items-center space-x-3">
                <div class="bg-white text-mk-red font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm" id="cart-count">0</div>
                <span class="font-medium">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </div>
            <span class="font-bold text-lg" id="cart-total">0 ‡∏ø</span>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end justify-center transition-opacity">
        <div class="bg-white w-full h-[90vh] rounded-t-3xl p-6 overflow-y-auto relative animate-slide-up">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                <button onclick="closeCheckoutModal()" class="text-gray-400 hover:text-red-500">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div id="cart-items-container" class="space-y-4 mb-6"></div>
            <div class="border-t border-dashed my-4"></div>

            <form id="orderForm" class="space-y-4">
                <h3 class="font-bold text-gray-700">üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                
                <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                <input type="tel" id="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" required>
                
                <div class="relative">
                    <textarea id="address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 pr-10" required></textarea>
                    <button type="button" onclick="getLocation()" class="absolute top-2 right-2 text-mk-red hover:text-red-800 p-1" title="‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                        <i class="fas fa-map-marker-alt fa-lg"></i>
                    </button>
                </div>
                <p id="location-status" class="text-xs text-gray-400 ml-1">‡∏Å‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>

                <h3 class="font-bold text-gray-700 mt-4">üì∏ ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative hover:bg-gray-100 transition">
                    <input type="file" id="slip" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewSlip(this)">
                    <div id="slip-preview-box">
                        <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-500">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
                    </div>
                    <img id="slip-img" class="hidden max-h-40 mx-auto rounded-lg shadow-sm">
                </div>
                
                <div class="h-24"></div> <div class="fixed bottom-0 left-0 w-full bg-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] border-t z-50">
                    <button type="submit" id="submitBtn" class="w-full bg-mk-red text-white font-bold py-3 rounded-xl shadow-lg hover-bg-mk-dark transition flex justify-between px-6">
                        <span>‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢</span>
                        <span id="final-total">0 ‡∏ø</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const LIFF_ID = "2006820737-B6zOM56Y";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyL-HaoVYFxy3RRDLNXaandxLmC1dE-cCBQy6MUrRGuGMhkLP9wX82yM_025HC2WuHSbw/exec";


        let allProducts = [];
        let cart = {}; 
        let userLineUid = "";

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userLineUid = profile.userId;
                    
                    document.getElementById('user-profile').innerHTML = `<img src="${profile.pictureUrl}" class="w-8 h-8 rounded-full border border-gray-200">`;
                    document.getElementById('user-profile').classList.remove('hidden');
                    
                    fetchProducts();
                    fetchUserData(userLineUid); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
                }
            } catch (err) {
                console.error(err);
                alert("LIFF Error: " + err.message);
            }
        }

        // --- FETCH DATA ---
        function fetchProducts() {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    allProducts = data;
                    setupCategories(data);
                    renderProducts(data);
                });
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤
        function fetchUserData(uid) {
            // ‡∏™‡πà‡∏á parameter action=get_user ‡πÑ‡∏õ
            fetch(`${GAS_URL}?action=get_user&uid=${uid}`)
                .then(res => res.json())
                .then(data => {
                    if (data.found) {
                        document.getElementById('name').value = data.name;
                        document.getElementById('tel').value = data.telephone;
                        document.getElementById('address').value = data.address;
                        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                        const btn = document.getElementById('submitBtn');
                        const originalText = btn.innerHTML;
                        // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ó‡∏≥ Toast notification ‡∏Å‡πá‡πÑ‡∏î‡πâ
                    }
                });
        }

        // --- CATEGORIES ---
        function setupCategories(products) {
            const categories = [...new Set(products.map(p => p.category))]; // ‡∏´‡∏≤ category ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
            const container = document.getElementById('category-container');
            
            categories.forEach(cat => {
                if(!cat) return;
                const btn = document.createElement('button');
                btn.className = 'category-btn whitespace-nowrap px-4 py-1 rounded-full border border-gray-300 text-sm text-gray-600 transition mx-1';
                btn.innerText = cat;
                btn.onclick = () => filterCategory(cat, btn);
                container.appendChild(btn);
            });
        }

        function filterCategory(cat, btnElement) {
            // Toggle Active Class
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active', 'border-mk-red', 'text-white'));
            
            if (btnElement) {
                btnElement.classList.add('active'); // CSS ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÉ‡∏´‡πâ
            } else {
                // ‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                document.querySelector('.category-btn').classList.add('active');
            }

            if (cat === 'all') {
                renderProducts(allProducts);
            } else {
                const filtered = allProducts.filter(p => p.category === cat);
                renderProducts(filtered);
            }
        }

        // --- RENDER ---
        function renderProducts(products) {
            const container = document.getElementById('product-list');
            container.innerHTML = "";
            
            products.forEach(p => {
                const html = `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden flex flex-col fade-in relative border border-transparent hover:border-red-100 transition">
                        <div class="h-32 w-full relative bg-gray-100">
                            <img src="${p.image}" class="w-full h-full object-cover" alt="${p.name}" loading="lazy">
                        </div>
                        <div class="p-3 flex flex-col flex-grow">
                            <h3 class="font-bold text-gray-800 text-sm line-clamp-1">${p.name}</h3>
                            <p class="text-xs text-gray-500 mb-2">${p.category || ''}</p>
                            <div class="mt-auto flex justify-between items-center">
                                <span class="font-bold text-mk-red">${p.price}.-</span>
                                <button onclick="addToCart('${p.id}')" class="bg-red-50 text-mk-red hover:bg-mk-red hover:text-white w-8 h-8 rounded-full flex items-center justify-center transition shadow-sm border border-red-100">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- GPS LOCATION ---
        function getLocation() {
            const status = document.getElementById('location-status');
            const addrInput = document.getElementById('address');
            
            if (!navigator.geolocation) {
                status.innerText = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS";
                return;
            }

            status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;
                    const mapsLink = `https://www.google.com/maps?q=${lat},${long}`;
                    
                    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)
                    if(addrInput.value) {
                         addrInput.value += `\n(‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${mapsLink})`;
                    } else {
                         addrInput.value = `(‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${mapsLink})`;
                    }
                    status.innerText = "‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                    status.className = "text-xs text-green-600 ml-1";
                },
                (error) => {
                    status.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ";
                    status.className = "text-xs text-red-500 ml-1";
                    console.error(error);
                }
            );
        }

        // --- CART & MODAL LOGIC (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ) ---
        function addToCart(id) {
            const product = allProducts.find(p => p.id == id);
            if (cart[id]) cart[id].quantity++;
            else cart[id] = { ...product, quantity: 1 };
            updateCartUI();
        }

        function removeFromCart(id) {
            if (cart[id]) {
                cart[id].quantity--;
                if (cart[id].quantity <= 0) delete cart[id];
            }
            updateCartUI();
        }

        function updateCartUI() {
            const items = Object.values(cart);
            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            document.getElementById('cart-count').innerText = totalQty;
            document.getElementById('cart-total').innerText = totalPrice.toLocaleString() + ' ‡∏ø';
            document.getElementById('final-total').innerText = totalPrice.toLocaleString() + ' ‡∏ø';

            const cartBar = document.getElementById('cart-bar');
            if (totalQty > 0) cartBar.classList.remove('hidden', 'translate-y-full');
            else {
                cartBar.classList.add('translate-y-full');
                closeCheckoutModal();
            }
            renderCartModalItems();
        }

        function openCheckoutModal() {
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.body.classList.add('modal-open');
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        function renderCartModalItems() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = "";
            Object.values(cart).forEach(item => {
                const html = `
                    <div class="flex items-center justify-between bg-white border-b pb-3 last:border-0">
                        <div class="flex items-center space-x-3">
                            <div class="bg-gray-100 rounded-lg h-12 w-12 flex-shrink-0 overflow-hidden">
                                <img src="${item.image}" class="h-full w-full object-cover">
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.price} x ${item.quantity} = ${(item.price * item.quantity).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 bg-gray-50 rounded-lg p-1">
                            <button onclick="removeFromCart('${item.id}')" class="w-7 h-7 bg-white rounded shadow text-mk-red flex items-center justify-center active:scale-95"><i class="fas fa-minus text-xs"></i></button>
                            <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                            <button onclick="addToCart('${item.id}')" class="w-7 h-7 bg-mk-red rounded shadow text-white flex items-center justify-center active:scale-95"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                    </div>`;
                container.innerHTML += html;
            });
        }

        function previewSlip(input) {
            const box = document.getElementById('slip-preview-box');
            const img = document.getElementById('slip-img');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    box.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- SUBMIT ---
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userLineUid) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE");

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            btn.disabled = true;

            const name = document.getElementById('name').value;
            const tel = document.getElementById('tel').value;
            const address = document.getElementById('address').value;
            const fileInput = document.getElementById('slip');
            
            let base64Image = "";
            if (fileInput.files.length > 0) {
                base64Image = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            const itemsArray = Object.values(cart);
            const totalPrice = itemsArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            const payload = {
                lineUid: userLineUid,
                name: name,
                telephone: tel,
                address: address,
                image: base64Image,
                orderDetails: itemsArray,
                totalPrice: totalPrice
            };

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                liff.closeWindow();
            }).catch(err => {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        main();
    </script>
</body>
</html>
