<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Shop</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Font ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏ß‡∏¢‡πÜ */
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #F3F4F6; padding-bottom: 80px; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal */
        .modal-open { overflow: hidden; }
        
        /* Animation ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="bg-white shadow-sm sticky top-0 z-10 p-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">üçΩÔ∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢</h1>
            <p class="text-xs text-gray-500">‡∏™‡∏±‡πà‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡πà‡∏á‡πÑ‡∏ß ‡∏ñ‡∏∂‡∏á‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì</p>
        </div>
        <div id="user-profile" class="hidden">
            </div>
    </div>

    <div class="container mx-auto p-4">
        <div id="product-list" class="grid grid-cols-2 gap-4">
            <div class="bg-white rounded-xl p-3 shadow-sm animate-pulse h-48"></div>
            <div class="bg-white rounded-xl p-3 shadow-sm animate-pulse h-48"></div>
            <div class="bg-white rounded-xl p-3 shadow-sm animate-pulse h-48"></div>
            <div class="bg-white rounded-xl p-3 shadow-sm animate-pulse h-48"></div>
        </div>
    </div>

    <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 z-20 hidden transform transition-transform duration-300 translate-y-full">
        <div onclick="openCheckoutModal()" class="bg-green-600 text-white rounded-lg p-3 flex justify-between items-center shadow-lg cursor-pointer active:scale-95 transition-transform">
            <div class="flex items-center space-x-3">
                <div class="bg-white text-green-600 font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm" id="cart-count">0</div>
                <span class="font-medium">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            </div>
            <span class="font-bold text-lg" id="cart-total">0 ‡∏ø</span>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end justify-center transition-opacity">
        <div class="bg-white w-full h-[90vh] rounded-t-3xl p-6 overflow-y-auto relative animate-slide-up">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <button onclick="closeCheckoutModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div id="cart-items-container" class="space-y-4 mb-6">
                </div>

            <div class="border-t border-dashed my-4"></div>

            <form id="orderForm" class="space-y-4">
                <h3 class="font-bold text-gray-700">üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                
                <div>
                    <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div>
                    <input type="tel" id="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div>
                    <textarea id="address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á / ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                </div>

                <h3 class="font-bold text-gray-700 mt-4">üì∏ ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative hover:bg-gray-100 transition">
                    <input type="file" id="slip" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewSlip(this)">
                    <div id="slip-preview-box">
                        <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-500">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
                    </div>
                    <img id="slip-img" class="hidden max-h-40 mx-auto rounded-lg shadow-sm">
                </div>
                
                <div class="h-20"></div>

                <div class="fixed bottom-0 left-0 w-full bg-white p-4 shadow-lg border-t">
                    <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-700 transition flex justify-between px-6">
                        <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
                        <span id="final-total">0 ‡∏ø</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION --- */
         const LIFF_ID = "2006820737-B6zOM56Y";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyL-HaoVYFxy3RRDLNXaandxLmC1dE-cCBQy6MUrRGuGMhkLP9wX82yM_025HC2WuHSbw/exec";

        /* --- STATE --- */
        let products = [];
        let cart = {}; // ‡πÉ‡∏ä‡πâ Object ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ { 'id1': {item...}, 'id2': {item...} }
        let userLineUid = "";

        /* --- INITIALIZATION --- */
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userLineUid = profile.userId;
                    
                    // Show Profile Pic
                    document.getElementById('user-profile').innerHTML = `<img src="${profile.pictureUrl}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">`;
                    document.getElementById('user-profile').classList.remove('hidden');
                    
                    fetchProducts();
                }
            } catch (err) {
                console.error(err);
                alert("LIFF Error: " + err.message);
            }
        }

        /* --- FETCH PRODUCTS --- */
        function fetchProducts() {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    products = data;
                    renderProducts();
                })
                .catch(err => {
                    document.getElementById('product-list').innerHTML = `<div class="col-span-2 text-center text-red-500 py-10">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
                });
        }

        /* --- RENDER PRODUCTS (GRID) --- */
        function renderProducts() {
            const container = document.getElementById('product-list');
            container.innerHTML = "";
            
            products.forEach(p => {
                const html = `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden flex flex-col fade-in relative group">
                        <div class="h-40 w-full relative">
                            <img src="${p.image}" class="w-full h-full object-cover" alt="${p.name}">
                        </div>
                        <div class="p-3 flex flex-col flex-grow">
                            <h3 class="font-bold text-gray-800 text-sm line-clamp-1">${p.name}</h3>
                            <p class="text-xs text-gray-500 mb-2">${p.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</p>
                            <div class="mt-auto flex justify-between items-center">
                                <span class="font-bold text-green-600">${p.price}.-</span>
                                <button onclick="addToCart('${p.id}')" class="bg-green-100 text-green-700 hover:bg-green-600 hover:text-white w-8 h-8 rounded-full flex items-center justify-center transition shadow-sm">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        /* --- CART LOGIC --- */
        function addToCart(id) {
            const product = products.find(p => p.id == id);
            
            if (cart[id]) {
                cart[id].quantity++;
            } else {
                cart[id] = { ...product, quantity: 1 };
            }
            updateCartUI();
        }

        function removeFromCart(id) {
            if (cart[id]) {
                cart[id].quantity--;
                if (cart[id].quantity <= 0) {
                    delete cart[id];
                }
            }
            updateCartUI();
        }

        function updateCartUI() {
            const items = Object.values(cart);
            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Update Floating Bar
            document.getElementById('cart-count').innerText = totalQty;
            document.getElementById('cart-total').innerText = totalPrice.toLocaleString() + ' ‡∏ø';
            document.getElementById('final-total').innerText = totalPrice.toLocaleString() + ' ‡∏ø';

            const cartBar = document.getElementById('cart-bar');
            if (totalQty > 0) {
                cartBar.classList.remove('hidden', 'translate-y-full');
            } else {
                cartBar.classList.add('translate-y-full');
                closeCheckoutModal(); // ‡∏õ‡∏¥‡∏î Modal ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î
            }

            renderCartModalItems();
        }

        /* --- CHECKOUT MODAL LOGIC --- */
        function openCheckoutModal() {
            document.getElementById('checkout-modal').classList.remove('hidden');
            document.body.classList.add('modal-open');
            renderCartModalItems();
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        function renderCartModalItems() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = "";
            
            Object.values(cart).forEach(item => {
                const html = `
                    <div class="flex items-center justify-between bg-white border-b pb-3 last:border-0">
                        <div class="flex items-center space-x-3">
                            <div class="bg-gray-100 rounded-lg h-12 w-12 flex-shrink-0 overflow-hidden">
                                <img src="${item.image}" class="h-full w-full object-cover">
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.price} x ${item.quantity} = ${(item.price * item.quantity).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 bg-gray-50 rounded-lg p-1">
                            <button onclick="removeFromCart('${item.id}')" class="w-7 h-7 bg-white rounded shadow text-green-600 flex items-center justify-center active:scale-95">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                            <button onclick="addToCart('${item.id}')" class="w-7 h-7 bg-green-600 rounded shadow text-white flex items-center justify-center active:scale-95">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        /* --- SLIP PREVIEW --- */
        function previewSlip(input) {
            const box = document.getElementById('slip-preview-box');
            const img = document.getElementById('slip-img');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    box.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        /* --- SUBMIT ORDER --- */
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userLineUid) return alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô LINE ‡πÑ‡∏î‡πâ");

            // UI Loading
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            btn.disabled = true;
            btn.classList.add('bg-gray-400');

            // Data Prep
            const name = document.getElementById('name').value;
            const tel = document.getElementById('tel').value;
            const address = document.getElementById('address').value;
            const fileInput = document.getElementById('slip');
            
            let base64Image = "";
            if (fileInput.files.length > 0) {
                base64Image = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            const itemsArray = Object.values(cart);
            const totalPrice = itemsArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            const payload = {
                lineUid: userLineUid,
                name: name,
                telephone: tel,
                address: address,
                image: base64Image,
                orderDetails: itemsArray,
                totalPrice: totalPrice
            };

            // Send to GAS
            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                liff.closeWindow();
            }).catch(err => {
                console.error(err);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('bg-gray-400');
            });
        });

        main();
    </script>
</body>
</html>
